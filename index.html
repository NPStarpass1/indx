<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบสัญญาผ่อนรถ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;family=Prompt:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    .font-prompt {
      font-family: 'Prompt', sans-serif;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    .gradient-primary {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
    }
    .gradient-gold {
      background: linear-gradient(135deg, #d4a854 0%, #f4d794 50%, #d4a854 100%);
    }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-rent { background: #10b981; color: white; }
    .status-installment { background: #f59e0b; color: white; }
    .status-broken { background: #ef4444; color: white; }
    .status-processing { background: #3b82f6; color: white; }
    .status-broken-processing { background: #8b5cf6; color: white; }
    .status-expired { background: #6b7280; color: white; }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .input-field {
      transition: all 0.2s ease;
      border: 2px solid #e5e7eb;
    }
    .input-field:focus {
      border-color: #1e3a5f;
      box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(30, 58, 95, 0.4);
    }
    .btn-gold {
      background: linear-gradient(135deg, #d4a854 0%, #f4d794 100%);
      color: #1e3a5f;
      transition: all 0.3s ease;
    }
    .btn-gold:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(212, 168, 84, 0.4);
    }
    .watermark {
      position: absolute;
      font-size: 120px;
      color: rgba(30, 58, 95, 0.03);
      font-weight: 700;
      transform: rotate(-30deg);
      pointer-events: none;
    }
    .contract-paper {
      background: linear-gradient(180deg, #fefefe 0%, #f8f9fa 100%);
      border: 1px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    .contract-paper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(135deg, #1e3a5f 0%, #d4a854 100%);
    }
    .seal {
      width: 80px;
      height: 80px;
      border: 3px solid #d4a854;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #fef9e7 0%, #fff 100%);
    }
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #d4a854, transparent);
    }
    .section-title {
      color: #1e3a5f;
      border-bottom: 2px solid #d4a854;
      padding-bottom: 8px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-100">
  <div id="app" class="h-full overflow-auto"><!-- Login Page -->
   <div id="login-page" class="min-h-full flex items-center justify-center p-4" style="background: linear-gradient(135deg, #1e3a5f 0%, #0f1c2e 100%);">
    <div class="w-full max-w-md">
     <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-full gradient-gold mb-4">
       <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
      </div>
      <h1 class="text-3xl font-prompt font-bold text-white mb-2">ระบบสัญญาผ่อนรถ</h1>
      <p class="text-gray-300">Vehicle Installment Contract System</p>
     </div>
     <div class="glass-effect rounded-2xl shadow-2xl p-8">
      <div class="space-y-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช�� (Username)</label> <input type="text" id="login-username" class="input-field w-full px-4 py-3 rounded-lg outline-none" placeholder="กรอกชื่อผู้ใช้">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน (Password)</label> <input type="password" id="login-password" class="input-field w-full px-4 py-3 rounded-lg outline-none" placeholder="กรอกรหัสผ่าน">
       </div>
       <div id="login-error" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-lg"></div><button onclick="handleLogin()" class="btn-primary w-full py-3 rounded-lg text-white font-semibold"> เข้าสู่ระบบ </button>
       <div class="divider my-4"></div><button onclick="enterAsViewer()" class="btn-gold w-full py-3 rounded-lg font-semibold"> เข้าชมสัญญา (Guest) </button>
      </div>
     </div>
     <p class="text-center text-gray-400 text-sm mt-6">© 2024 Vehicle Contract Management System</p>
    </div>
   </div><!-- Main Dashboard -->
   <div id="dashboard-page" class="hidden min-h-full"><!-- Header -->
    <header class="gradient-primary text-white shadow-lg sticky top-0 z-50">
     <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
       <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full gradient-gold flex items-center justify-center">
         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
        </div>
        <div>
         <h1 id="system-title" class="text-xl font-prompt font-bold">ระบบสัญญาผ่อนรถ</h1>
         <p class="text-sm text-gray-300">Vehicle Installment Contract System</p>
        </div>
       </div>
       <div class="flex items-center gap-4">
        <div class="text-right">
         <p class="text-sm text-gray-300">ยินดีต้อนรับ</p>
         <p id="user-display-name" class="font-semibold"></p>
         <p id="user-role-badge" class="text-xs"></p>
        </div><button onclick="handleLogout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
         </svg> ออกจากระบบ </button>
       </div>
      </div>
     </div>
    </header><!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6"><!-- Stats Cards -->
     <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-md p-5 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">สัญญาทั้งหมด</p>
         <p id="stat-total" class="text-2xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">เช่า</p>
         <p id="stat-active" class="text-2xl font-bold text-green-600">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">ผ่อน</p>
         <p id="stat-pending" class="text-2xl font-bold text-orange-600">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-5 card-hover">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">อื่นๆ (บิด/ดำเนินการ/หมดอายุ)</p>
         <p id="stat-completed" class="text-2xl font-bold text-blue-600">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
         </svg>
        </div>
       </div>
      </div>
     </div><!-- Action Bar -->
     <div class="bg-white rounded-xl shadow-md p-4 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
       <div class="flex items-center gap-4 flex-1">
        <div class="relative flex-1 max-w-md"><input type="text" id="search-input" placeholder="ค้นหาสัญญา (หมายเลข, ชื่อ, ทะเบียน...)" class="input-field w-full pl-10 pr-4 py-2 rounded-lg outline-none">
         <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
         </svg>
        </div><select id="filter-status" class="input-field px-4 py-2 rounded-lg outline-none"> <option value="">ทุกสถานะ</option> <option value="เช่า">เช่า</option> <option value="ผ่อน">ผ่อน</option> <option value="บิด">บิด</option> <option value="ดำเนินการ">ดำเนินการ</option> <option value="บิดรอดำเนินการส่งเรื่อง">บิดรอดำเนินการส่งเรื่อง</option> <option value="หมดอายุ">หมดอายุ</option> </select>
       </div><button id="btn-create-contract" onclick="showCreateModal()" class="btn-primary px-6 py-2 rounded-lg text-white font-semibold flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg> สร้างสัญญาใหม่ </button>
      </div>
     </div><!-- Contracts List -->
     <div id="contracts-list" class="space-y-4">
      <div class="text-center py-12 text-gray-500">
       <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
       <p>ยังไม่มีสัญญาในระบบ</p>
      </div>
     </div>
    </main>
   </div><!-- Create/Edit Contract Modal -->
   <div id="contract-modal" class="modal-overlay hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4 animate-fade-in">
     <div class="gradient-primary text-white p-6 rounded-t-2xl">
      <div class="flex items-center justify-between">
       <h2 id="modal-title" class="text-xl font-prompt font-bold">สร้างสัญญาใหม่</h2><button onclick="closeModal()" class="hover:bg-white/20 p-2 rounded-lg transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>
     </div>
     <form id="contract-form" class="p-6 space-y-6"><input type="hidden" id="form-contract-id"> <input type="hidden" id="form-backend-id"> <!-- Lessor Info -->
      <div class="border-l-4 border-blue-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg> ข้อมูลผู้ปล่อยเช่า (Lessor)</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label> <input type="text" id="form-lessor-name" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Username</label> <input type="text" id="form-lessor-username" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
       </div>
      </div><!-- Lessee Info -->
      <div class="border-l-4 border-green-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg> ข้อมูลผู้เช่า (Lessee)</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ชื่อ</label> <input type="text" id="form-lessee-name" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Username</label> <input type="text" id="form-lessee-username" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
       </div>
      </div><!-- Vehicle Info -->
      <div class="border-l-4 border-purple-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
        </svg> ��ายละเอียดรถ</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ประเภทรถ</label> <input type="text" id="form-vehicle-type" required class="input-field w-full px-3 py-2 rounded-lg outline-none" placeholder="เช่น รถเก๋ง, รถกระบะ">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ป้ายทะเบียน</label> <input type="text" id="form-license-plate" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
       </div>
      </div><!-- Rental Details -->
      <div class="border-l-4 border-orange-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg> ��ายละเอียดการเช่า</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">วันที่���ริ่มเช่า (รับรถ)</label> <input type="date" id="form-start-date" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">วันที่คืนรถ</label> <input type="date" id="form-end-date" required class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">จำนวนวันยืม</label> <input type="number" id="form-rental-days" readonly class="input-field w-full px-3 py-2 rounded-lg outline-none bg-gray-50">
        </div>
       </div>
      </div><!-- Payment Details -->
      <div class="border-l-4 border-red-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> ค่าใช้จ่าย</h3>
       <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">อัตราค่าผ่อน (บาท)</label> <input type="number" id="form-installment-rate" required min="0" class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ค่ามัดจำ (บาท)</label> <input type="number" id="form-deposit" required min="0" class="input-field w-full px-3 py-2 rounded-lg outline-none">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">ยอดรวมที่ต้องชำระ (บาท)</label> <input type="number" id="form-total-amount" readonly class="input-field w-full px-3 py-2 rounded-lg outline-none bg-gray-50 font-semibold text-green-600">
        </div>
       </div>
      </div><!-- Conditions -->
      <div class="border-l-4 border-gray-500 pl-4">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg> เงื่อนไขและข้อตกลง</h3><textarea id="form-conditions" rows="3" class="input-field w-full px-3 py-2 rounded-lg outline-none" placeholder="ระบุเงื่อนไขเพิ่มเติม (ถ้ามี)"></textarea>
      </div><!-- Status (Staff and Admin) -->
      <div id="status-section-staff" class="border-l-4 border-indigo-500 pl-4 hidden">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
        </svg> สถานะสัญญา</h3><select id="form-status-staff" class="input-field w-full px-3 py-2 rounded-lg outline-none"> <option value="เช่า">เช่า</option> <option value="ผ่อน">ผ่อน</option> </select>
      </div><!-- Status (Admin Only) -->
      <div id="status-section-admin" class="border-l-4 border-red-500 pl-4 hidden">
       <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
        </svg> สถานะสัญญา (ผู้ดูแลเท่านั้น)</h3><select id="form-status-admin" onchange="handleStatusChange()" class="input-field w-full px-3 py-2 rounded-lg outline-none"> <option value="เช่า">เช่า</option> <option value="ผ่อน">ผ่อน</option> <option value="บิด">บิด</option> <option value="ดำเนินการ">ดำเนินการ</option> <option value="บิดรอดำเนินการส่งเรื่อง">บิดรอดำเนินการส่งเรื่อง</option> <option value="หมดอายุ">หมดอายุ</option> </select>
      </div><!-- Broken Car Details (Admin Only - appears when status is "บิด") -->
      <div id="broken-section" class="border-l-4 border-red-600 pl-4 hidden bg-red-50 p-4 rounded-lg">
       <h3 class="font-semibold text-red-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4v2m0 0v2m0-6v-2m0 0V7a2 2 0 012-2h2.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2h-3m-6-2h6m-6 0V5m6 14v-2m0 0h2" />
        </svg> รายละเอียดรถที่ชำรุด</h3>
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-red-800 mb-1">ป้ายทะเบียนรถใหม่</label> <input type="text" id="form-broken-license-plate" class="input-field w-full px-3 py-2 rounded-lg outline-none" placeholder="กรอกป้ายทะเบียนรถที่ใช้แทน">
        </div>
        <div><label class="block text-sm font-medium text-red-800 mb-1">หมายเหตุ / รายละเอียดการชำรุด</label> <textarea id="form-broken-notes" rows="3" class="input-field w-full px-3 py-2 rounded-lg outline-none" placeholder="อธิบายรายละเอียดก��รชำรุดของรถ เช่น ที่ใดชำ��ุด อาการเป็นอย่างไร เป็นต้น"></textarea>
        </div>
       </div>
      </div>
      <div class="flex gap-4 pt-4"><button type="button" onclick="closeModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition"> ยกเลิ�� </button> <button type="submit" id="btn-submit-form" class="flex-1 btn-primary px-6 py-3 rounded-lg text-white font-semibold"> บันทึกสัญญา </button>
      </div>
     </form>
    </div>
   </div><!-- View Contract Modal -->
   <div id="view-modal" class="modal-overlay hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4 animate-fade-in">
     <div class="p-6">
      <div class="flex justify-end mb-4"><button onclick="closeViewModal()" class="hover:bg-gray-100 p-2 rounded-lg transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>
      <div id="contract-view-content" class="contract-paper rounded-xl p-8 relative"><!-- Contract content will be inserted here -->
      </div>
     </div>
    </div>
   </div><!-- Delete Confirmation Modal -->
   <div id="delete-modal" class="modal-overlay hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md m-4 animate-fade-in">
     <div class="p-6 text-center">
      <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
       </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">ยืนยันการลบสัญญา</h3>
      <p class="text-gray-500 mb-6">คุณต้องการลบสัญญานี้หรือไม่? ก��รดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
      <div class="flex gap-4"><button onclick="closeDeleteModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition"> ยกเลิก </button> <button id="btn-confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg text-white font-semibold transition"> ลบสัญญา </button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // User credentials database
    const USERS = {
      admin: {
        username: 'mixka zan',
        password: '17519532486',
        role: 'admin',
        displayName: 'Mixka Zan',
        canEdit: true,
        canCreate: true,
        canDelete: true,
        canChangeStatus: true
      },
      staff: [
        { username: 'MK_Ayame', password: 'zxcvbn123', displayName: 'Mixka Playboy', role: 'staff' },
        { username: 'EXP_99K', password: 'zxcvbn123', displayName: 'Thug Rario', role: 'staff' },
        { username: 'deklaaon098', password: 'zxcvbn123', displayName: 'Yuji', role: 'staff' },
        { username: 'CKCH7549', password: 'zxcvbn123', displayName: 'Atom Mikimoto', role: 'staff' },
        { username: 'x_ai23', password: 'zxcvbn123', displayName: 'Idea Ravencircle', role: 'staff' },
        { username: 'JUYNM843', password: 'zxcvbn123', displayName: 'Tang maikinjun', role: 'staff' },
        { username: 'GARREM_GARIET', password: 'zxcvbn123', displayName: 'กาดุม', role: 'staff' }
      ]
    };

    // Current user state
    let currentUser = null;
    let contracts = [];
    let editingContractId = null;
    let deletingContract = null;

    // Default config
    const defaultConfig = {
      system_title: 'ระบบสัญญาผ่อนรถ',
      primary_color: '#1e3a5f',
      accent_color: '#d4a854',
      text_color: '#333333',
      background_color: '#f3f4f6',
      card_color: '#ffffff'
    };

    let config = { ...defaultConfig };

    // Element SDK initialization
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => cfg.primary_color || defaultConfig.primary_color,
              set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => cfg.accent_color || defaultConfig.accent_color,
              set: (v) => { cfg.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }
            },
            {
              get: () => cfg.text_color || defaultConfig.text_color,
              set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => cfg.background_color || defaultConfig.background_color,
              set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => cfg.card_color || defaultConfig.card_color,
              set: (v) => { cfg.card_color = v; window.elementSdk.setConfig({ card_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['system_title', cfg.system_title || defaultConfig.system_title]
        ])
      });
    }

    function applyConfig() {
      const title = document.getElementById('system-title');
      if (title) title.textContent = config.system_title || defaultConfig.system_title;
    }

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        contracts = data || [];
        checkExpiredContracts();
        renderContracts();
        updateStats();
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      if (!window.dataSdk) {
        console.warn('Data SDK not available');
        showToast('⚠️ Data SDK ยังไม่พร้อม กรุณารอสักครู่', 'error');
        setTimeout(initDataSdk, 2000);
        return;
      }
      
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error('Failed to initialize data SDK:', result.error);
        showToast('❌ ไม่สามารถเชื่อมต่อกับ Sheet ได้', 'error');
      } else {
        console.log('Data SDK initialized successfully');
      }
    }

    // Generate random contract ID
    function generateContractId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let id = 'CTR-';
      for (let i = 0; i < 8; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
    }

    // Handle status change - show broken section when status is "บิด"
    function handleStatusChange() {
      const status = document.getElementById('form-status-admin').value;
      const brokenSection = document.getElementById('broken-section');
      
      if (status === 'บิด') {
        brokenSection.classList.remove('hidden');
      } else {
        brokenSection.classList.add('hidden');
        // Clear broken fields if status is changed away from "บิด"
        document.getElementById('form-broken-license-plate').value = '';
        document.getElementById('form-broken-notes').value = '';
      }
    }

    // Authentication functions
    function handleLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');

      // Check admin
      if (username.toLowerCase() === USERS.admin.username.toLowerCase() && password === USERS.admin.password) {
        currentUser = { ...USERS.admin };
        showDashboard();
        return;
      }

      // Check staff
      const staffUser = USERS.staff.find(s => 
        s.username.toLowerCase() === username.toLowerCase() && s.password === password
      );
      
      if (staffUser) {
        currentUser = { 
          ...staffUser, 
          canEdit: true, 
          canCreate: true, 
          canDelete: false, 
          canChangeStatus: true 
        };
        showDashboard();
        return;
      }

      errorDiv.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
      errorDiv.classList.remove('hidden');
    }

    function enterAsViewer() {
      currentUser = {
        username: 'guest',
        displayName: 'ผู้เยี่ยม��ม',
        role: 'viewer',
        canEdit: false,
        canCreate: false,
        canDelete: false,
        canChangeStatus: false
      };
      showDashboard();
    }

    function handleLogout() {
      currentUser = null;
      document.getElementById('login-page').classList.remove('hidden');
      document.getElementById('dashboard-page').classList.add('hidden');
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('dashboard-page').classList.remove('hidden');
      document.getElementById('user-display-name').textContent = currentUser.displayName;
      
      const roleBadge = document.getElementById('user-role-badge');
      const roleLabels = {
        admin: 'ผู้ดูแลระบบ',
        staff: 'เจ้าหน้าที่',
        viewer: 'ผู้เยี่ยมชม'
      };
      roleBadge.textContent = roleLabels[currentUser.role];
      roleBadge.className = 'text-xs px-2 py-1 rounded-full ' + 
        (currentUser.role === 'admin' ? 'bg-red-500' : 
         currentUser.role === 'staff' ? 'bg-blue-500' : 'bg-gray-500');

      // Show/hide create button based on permissions
      const createBtn = document.getElementById('btn-create-contract');
      if (createBtn) {
        createBtn.style.display = currentUser.canCreate ? 'flex' : 'none';
      }

      renderContracts();
      updateStats();
    }

    // Check and update expired contracts
    function checkExpiredContracts() {
      // This check can be used for notifications, but auto-update should only happen via admin action
    }

    // Contract CRUD operations
    function showCreateModal() {
      if (!currentUser.canCreate) {
        showToast('คุณไม่มีสิทธิ์สร้างสัญญา', 'error');
        return;
      }
      
      editingContractId = null;
      document.getElementById('modal-title').textContent = 'สร้างสัญญาใหม่';
      document.getElementById('contract-form').reset();
      document.getElementById('form-contract-id').value = '';
      document.getElementById('form-backend-id').value = '';
      
      // Show status sections based on role
      const staffSection = document.getElementById('status-section-staff');
      const adminSection = document.getElementById('status-section-admin');
      const brokenSection = document.getElementById('broken-section');
      
      if (currentUser.role === 'admin') {
        staffSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        document.getElementById('form-status-admin').value = 'เช่า';
        brokenSection.classList.add('hidden');
      } else {
        staffSection.classList.remove('hidden');
        adminSection.classList.add('hidden');
        document.getElementById('form-status-staff').value = 'เช่า';
      }
      
      document.getElementById('contract-modal').classList.remove('hidden');
    }

    function showEditModal(contract) {
      if (!currentUser.canEdit) {
        showToast('ค��ณไม่มีสิทธิ์แก้ไขสัญญา', 'error');
        return;
      }
      
      editingContractId = contract.__backendId;
      document.getElementById('modal-title').textContent = 'แก้ไขสัญญา';
      document.getElementById('form-contract-id').value = contract.contract_id;
      document.getElementById('form-backend-id').value = contract.__backendId;
      document.getElementById('form-lessor-name').value = contract.lessor_name;
      document.getElementById('form-lessor-username').value = contract.lessor_username;
      document.getElementById('form-lessee-name').value = contract.lessee_name;
      document.getElementById('form-lessee-username').value = contract.lessee_username;
      document.getElementById('form-vehicle-type').value = contract.vehicle_type;
      document.getElementById('form-license-plate').value = contract.license_plate;
      document.getElementById('form-start-date').value = contract.start_date;
      document.getElementById('form-end-date').value = contract.end_date;
      document.getElementById('form-rental-days').value = contract.rental_days;
      document.getElementById('form-installment-rate').value = contract.installment_rate;
      document.getElementById('form-deposit').value = contract.deposit;
      document.getElementById('form-total-amount').value = contract.total_amount;
      document.getElementById('form-conditions').value = contract.conditions || '';
      document.getElementById('form-broken-license-plate').value = contract.broken_license_plate || '';
      document.getElementById('form-broken-notes').value = contract.broken_notes || '';
      
      // Show status sections based on role
      const staffSection = document.getElementById('status-section-staff');
      const adminSection = document.getElementById('status-section-admin');
      const brokenSection = document.getElementById('broken-section');
      
      if (currentUser.role === 'admin') {
        staffSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        document.getElementById('form-status-admin').value = contract.status;
        
        // Show broken section if status is "บิด"
        if (contract.status === 'บิด') {
          brokenSection.classList.remove('hidden');
        } else {
          brokenSection.classList.add('hidden');
        }
      } else {
        staffSection.classList.remove('hidden');
        adminSection.classList.add('hidden');
        document.getElementById('form-status-staff').value = contract.status;
      }
      
      document.getElementById('contract-modal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('contract-modal').classList.add('hidden');
      editingContractId = null;
    }

    function showViewModal(contract) {
      const content = document.getElementById('contract-view-content');
      const statusClass = getStatusClass(contract.status);
      
      let brokenInfo = '';
      if (contract.status === 'บิด' && (contract.broken_license_plate || contract.broken_notes)) {
        brokenInfo = `
        <div class="bg-red-50 rounded-lg p-4 mb-6 border-l-4 border-red-500">
          <h3 class="section-title text-sm font-semibold mb-3 text-red-800">รายละเอียดรถที่ชำรุด</h3>
          ${contract.broken_license_plate ? `<p class="text-gray-800 mb-2"><span class="text-gray-500">ป้ายทะเบียนรถใหม่:</span> <span class="font-mono font-semibold">${contract.broken_license_plate}</span></p>` : ''}
          ${contract.broken_notes ? `<p class="text-gray-800"><span class="text-gray-500">หมายเหตุ:</span><br>${contract.broken_notes.replace(/\n/g, '<br>')}</p>` : ''}
        </div>
        `;
      }
      
      content.innerHTML = `
        <div class="watermark">สัญญา</div>
        
        <div class="text-center mb-8">
          <div class="seal mx-auto mb-4">
            <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
            </svg>
          </div>
          <h1 class="text-2xl font-prompt font-bold text-gray-800">สัญญาการผ่อนรถ</h1>
          <p class="text-gray-500">Vehicle Installment Contract</p>
          <p class="text-sm text-gray-400 mt-2">หมายเลขสัญญา: <span class="font-mono font-semibold text-gray-700">${contract.contract_id}</span></p>
        </div>

        <div class="flex items-center justify-between mb-6">
          <span class="status-badge ${statusClass}">${contract.status}</span>
          <span class="text-sm text-gray-500">เจ้าหน้าที่: ${contract.staff_name}</span>
        </div>

        <div class="divider mb-6"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-blue-50 rounded-lg p-4">
            <h3 class="section-title text-sm font-semibold mb-3">ข้อมูลผู้ปล่อยเช่า (Lessor)</h3>
            <p class="text-gray-800"><span class="text-gray-500">ชื่อ:</span> ${contract.lessor_name}</p>
            <p class="text-gray-800"><span class="text-gray-500">Username:</span> ${contract.lessor_username}</p>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <h3 class="section-title text-sm font-semibold mb-3">ข้อมูลผู้เช่า (Lessee)</h3>
            <p class="text-gray-800"><span class="text-gray-500">ชื่อ:</span> ${contract.lessee_name}</p>
            <p class="text-gray-800"><span class="text-gray-500">Username:</span> ${contract.lessee_username}</p>
          </div>
        </div>

        <div class="bg-purple-50 rounded-lg p-4 mb-6">
          <h3 class="section-title text-sm font-semibold mb-3">รายละเอียดรถ</h3>
          <div class="grid grid-cols-2 gap-4">
            <p class="text-gray-800"><span class="text-gray-500">ประเภท:</span> ${contract.vehicle_type}</p>
            <p class="text-gray-800"><span class="text-gray-500">ป้ายทะเบียน:</span> <span class="font-mono font-semibold">${contract.license_plate}</span></p>
          </div>
        </div>

        <div class="bg-orange-50 rounded-lg p-4 mb-6">
          <h3 class="section-title text-sm font-semibold mb-3">รายละเอียดการเช่า</h3>
          <div class="grid grid-cols-3 gap-4">
            <p class="text-gray-800"><span class="text-gray-500">วันที่เริ่มเช่า:</span><br>${formatDate(contract.start_date)}</p>
            <p class="text-gray-800"><span class="text-gray-500">วันที่คืนรถ:</span><br>${formatDate(contract.end_date)}</p>
            <p class="text-gray-800"><span class="text-gray-500">จำนวนวัน:</span><br>${contract.rental_days} วัน</p>
          </div>
        </div>

        <div class="bg-red-50 rounded-lg p-4 mb-6">
          <h3 class="section-title text-sm font-semibold mb-3">��่าใช้จ่าย</h3>
          <div class="grid grid-cols-3 gap-4">
            <p class="text-gray-800"><span class="text-gray-500">อัตราค่าผ่อน:</span><br>${formatCurrency(contract.installment_rate)}</p>
            <p class="text-gray-800"><span class="text-gray-500">ค่ามัดจำ:</span><br>${formatCurrency(contract.deposit)}</p>
            <p class="text-gray-800 font-semibold"><span class="text-gray-500">ยอดรวม:</span><br><span class="text-green-600">${formatCurrency(contract.total_amount)}</span></p>
          </div>
        </div>

        ${brokenInfo}

        ${contract.conditions ? `
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h3 class="section-title text-sm font-semibold mb-3">เงื่อนไขและข้อตกลง</h3>
          <p class="text-gray-800">${contract.conditions.replace(/\n/g, '<br>')}</p>
        </div>
        ` : ''}

        <div class="divider my-6"></div>

        <div class="text-center text-sm text-gray-400">
          <p>สร้างเมื่อ: ${formatDateTime(contract.created_at)}</p>
        </div>
      `;
      
      document.getElementById('view-modal').classList.remove('hidden');
    }

    function closeViewModal() {
      document.getElementById('view-modal').classList.add('hidden');
    }

    function showDeleteModal(contract) {
      if (!currentUser.canDelete) {
        showToast('คุณไม่มีสิทธิ์ลบสัญญา', 'error');
        return;
      }
      
      deletingContract = contract;
      document.getElementById('delete-modal').classList.remove('hidden');
      
      document.getElementById('btn-confirm-delete').onclick = async () => {
        if (deletingContract && window.dataSdk) {
          const result = await window.dataSdk.delete(deletingContract);
          if (result.isOk) {
            showToast('ลบสัญญาเรียบร้อ��แล้ว', 'success');
          } else {
            showToast('เกิดข้อผิดพลาดในการลบสัญญา', 'error');
          }
        }
        closeDeleteModal();
      };
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
      deletingContract = null;
    }

    // Form handling
    document.getElementById('contract-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (contracts.length >= 999 && !editingContractId) {
        showToast('ถึงขีดจำกัดสัญญาแล้ว (999 สัญญา)', 'error');
        return;
      }

      const formData = {
        contract_id: document.getElementById('form-contract-id').value || generateContractId(),
        status: currentUser.role === 'admin' 
          ? document.getElementById('form-status-admin').value 
          : document.getElementById('form-status-staff').value,
        staff_name: currentUser.displayName,
        lessor_name: document.getElementById('form-lessor-name').value,
        lessor_username: document.getElementById('form-lessor-username').value,
        lessee_name: document.getElementById('form-lessee-name').value,
        lessee_username: document.getElementById('form-lessee-username').value,
        vehicle_type: document.getElementById('form-vehicle-type').value,
        license_plate: document.getElementById('form-license-plate').value,
        start_date: document.getElementById('form-start-date').value,
        end_date: document.getElementById('form-end-date').value,
        rental_days: parseInt(document.getElementById('form-rental-days').value) || 0,
        installment_rate: parseFloat(document.getElementById('form-installment-rate').value) || 0,
        deposit: parseFloat(document.getElementById('form-deposit').value) || 0,
        total_amount: parseFloat(document.getElementById('form-total-amount').value) || 0,
        conditions: document.getElementById('form-conditions').value,
        broken_license_plate: document.getElementById('form-broken-license-plate').value || '',
        broken_notes: document.getElementById('form-broken-notes').value || '',
        created_at: editingContractId ? 
          (contracts.find(c => c.__backendId === editingContractId)?.created_at || new Date().toISOString()) : 
          new Date().toISOString()
      };

      const submitBtn = document.getElementById('btn-submit-form');
      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังบันทึก...';

      try {
        if (!window.dataSdk) {
          showToast('❌ Data SDK ไม่พร้อม กรุณารอสักครู่และลองอีกครั้ง', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'บันทึกสัญญา';
          return;
        }

        if (editingContractId) {
          const existingContract = contracts.find(c => c.__backendId === editingContractId);
          if (existingContract) {
            const result = await window.dataSdk.update({ ...existingContract, ...formData });
            if (result.isOk) {
              showToast('✅ แก้ไขสัญญาเรียบร้อยแล้ว', 'success');
              closeModal();
            } else {
              console.error('Update error:', result.error);
              showToast('❌ เกิดข้อผิดพลาดในการแก้ไขสัญญา: ' + (result.error?.message || 'ไม่ทราบสาเหตุ'), 'error');
            }
          } else {
            showToast('❌ ไม่พบสัญญาที่ต้องการแก้ไข', 'error');
          }
        } else {
          const result = await window.dataSdk.create(formData);
          if (result.isOk) {
            showToast('✅ สร้างสัญญาเรียบร้อยแล้ว', 'success');
            closeModal();
          } else {
            console.error('Create error:', result.error);
            showToast('❌ เกิดข้อผิดพลาดในการสร้างสัญญา: ' + (result.error?.message || 'ไม่ทราบสาเหตุ'), 'error');
          }
        }
      } catch (error) {
        console.error('Exception:', error);
        showToast('❌ เกิดข้อผิดพลาด: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'บันทึกสัญญา';
      }
    });

    // Calculate rental days
    document.getElementById('form-start-date').addEventListener('change', calculateRentalDays);
    document.getElementById('form-end-date').addEventListener('change', calculateRentalDays);

    function calculateRentalDays() {
      const startDate = document.getElementById('form-start-date').value;
      const endDate = document.getElementById('form-end-date').value;
      
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById('form-rental-days').value = Math.max(0, days);
      }
    }

    // Calculate total amount
    document.getElementById('form-installment-rate').addEventListener('input', calculateTotal);
    document.getElementById('form-deposit').addEventListener('input', calculateTotal);

    function calculateTotal() {
      const installment = parseFloat(document.getElementById('form-installment-rate').value) || 0;
      const deposit = parseFloat(document.getElementById('form-deposit').value) || 0;
      document.getElementById('form-total-amount').value = installment + deposit;
    }

    // Search and filter
    document.getElementById('search-input').addEventListener('input', renderContracts);
    document.getElementById('filter-status').addEventListener('change', renderContracts);

    // Render contracts list
    function renderContracts() {
      const container = document.getElementById('contracts-list');
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const statusFilter = document.getElementById('filter-status').value;
      
      let filteredContracts = contracts.filter(c => {
        const matchSearch = !searchTerm || 
          c.contract_id.toLowerCase().includes(searchTerm) ||
          c.lessor_name.toLowerCase().includes(searchTerm) ||
          c.lessee_name.toLowerCase().includes(searchTerm) ||
          c.license_plate.toLowerCase().includes(searchTerm) ||
          c.lessor_username.toLowerCase().includes(searchTerm) ||
          c.lessee_username.toLowerCase().includes(searchTerm);
        
        const matchStatus = !statusFilter || c.status === statusFilter;
        
        return matchSearch && matchStatus;
      });

      // Sort by created date (newest first)
      filteredContracts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      if (filteredContracts.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p>${searchTerm || statusFilter ? 'ไม่พบสัญญาที่ค้นหา' : 'ยังไม่มีสัญญาในระบบ'}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredContracts.map(contract => {
        const statusClass = getStatusClass(contract.status);
        const canEditThis = currentUser.canEdit;
        const canDeleteThis = currentUser.canDelete;
        
        return `
          <div class="bg-white rounded-xl shadow-md p-5 card-hover animate-fade-in">
            <div class="flex flex-wrap items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-3">
                  <span class="font-mono font-semibold text-gray-800">${contract.contract_id}</span>
                  <span class="status-badge ${statusClass}">${contract.status}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <p class="text-gray-500">ผู��เช่า</p>
                    <p class="font-medium">${contract.lessee_name}</p>
                    <p class="text-gray-400 text-xs">${contract.lessee_username}</p>
                  </div>
                  <div>
                    <p class="text-gray-500">รถ / ทะเบียน</p>
                    <p class="font-medium">${contract.vehicle_type}</p>
                    <p class="font-mono text-gray-600">${contract.license_plate}</p>
                  </div>
                  <div>
                    <p class="text-gray-500">ระยะเวลา</p>
                    <p class="font-medium">${formatDate(contract.start_date)} - ${formatDate(contract.end_date)}</p>
                    <p class="text-gray-400">${contract.rental_days} วัน</p>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick='showViewModal(${JSON.stringify(contract).replace(/'/g, "&#39;")})' class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="ดูรายละเอียด">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </button>
                ${canEditThis ? `
                <button onclick='showEditModal(${JSON.stringify(contract).replace(/'/g, "&#39;")})' class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg transition" title="แก้ไข">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                ` : ''}
                ${canDeleteThis ? `
                <button onclick='showDeleteModal(${JSON.stringify(contract).replace(/'/g, "&#39;")})' class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="��บ">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
                ` : ''}
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between text-xs text-gray-400">
              <span>เจ้าหน้าที่: ${contract.staff_name}</span>
              <span>ยอดรวม: ${formatCurrency(contract.total_amount)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update statistics
    function updateStats() {
      const total = contracts.length;
      const rent = contracts.filter(c => c.status === 'เช่า').length;
      const installment = contracts.filter(c => c.status === 'ผ่อน').length;
      const others = contracts.filter(c => ['บิด', 'ดำเนินการ', 'บิดรอดำเนินการส่งเรื่อง', 'หมดอายุ'].includes(c.status)).length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-active').textContent = rent;
      document.getElementById('stat-pending').textContent = installment;
      document.getElementById('stat-completed').textContent = others;
    }

    // Helper functions
    function getStatusClass(status) {
      const classes = {
        'กำลังผ่อน': 'status-active',
        'รอยืนยัน 24 ชม.': 'status-warning',
        'ผ่อนครบ': 'status-completed',
        'บิด': 'status-cancelled',
        'หมดอายุ': 'status-expired'
      };
      return classes[status] || 'status-pending';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('th-TH', { 
        style: 'currency', 
        currency: 'THB',
        minimumFractionDigits: 0
      }).format(amount || 0);
    }

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    initDataSdk();
    applyConfig();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7b5cb491fe8941',t:'MTc3MDA1Mjg1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
